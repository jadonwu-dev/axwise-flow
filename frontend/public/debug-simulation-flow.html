<!DOCTYPE html>
<html>
<head>
    <title>Debug Simulation Flow</title>
</head>
<body>
    <h1>Debug Simulation Flow</h1>
    <div id="output"></div>
    
    <script>
        const STORAGE_KEY = 'simulation_results';
        
        function debugSimulationFlow() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîç SIMULATION FLOW DEBUG</h2>
                <p>This tool helps debug why simulations aren't appearing in the history page.</p>
            `;
            
            // Check current localStorage state
            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            output.innerHTML += `
                <h3>üìä Current localStorage State:</h3>
                <p><strong>Total Simulations:</strong> ${existingResults.length}</p>
            `;
            
            if (existingResults.length > 0) {
                output.innerHTML += '<h4>Recent Simulations:</h4>';
                existingResults.slice(-5).forEach((sim, index) => {
                    const simId = sim.simulation_id || sim.results?.simulation_id || 'Unknown';
                    const timestamp = sim.timestamp ? new Date(sim.timestamp).toLocaleString() : 'Unknown';
                    
                    output.innerHTML += `
                        <div style="border: 1px solid #ddd; margin: 5px 0; padding: 10px; background: #f9f9f9;">
                            <p><strong>ID:</strong> ${simId}</p>
                            <p><strong>Source:</strong> ${sim.source}</p>
                            <p><strong>Timestamp:</strong> ${timestamp}</p>
                            <p><strong>Has Results:</strong> ${!!sim.results}</p>
                            <p><strong>Has Interviews:</strong> ${!!(sim.results?.interviews || sim.results?.data?.interviews)}</p>
                            <button onclick="testSimulationInHistory('${simId}')">Test in History Page</button>
                        </div>
                    `;
                });
            } else {
                output.innerHTML += '<p style="color: red;">‚ùå No simulations found in localStorage</p>';
            }
            
            // Add debugging tools
            output.innerHTML += `
                <h3>üß™ Debug Tools:</h3>
                <button onclick="simulateProgressPolling()">Simulate Progress Polling</button>
                <button onclick="simulate404Handling()">Simulate 404 Handling</button>
                <button onclick="testHistoryPageLoading()">Test History Page Loading</button>
                <button onclick="clearStorage()">Clear Storage</button>
                <button onclick="window.location.reload()">Refresh</button>
            `;
            
            // Add console monitoring
            output.innerHTML += `
                <h3>üìù Console Monitoring:</h3>
                <div id="console-output" style="background: #f0f0f0; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;">
                    <p>Console messages will appear here...</p>
                </div>
            `;
            
            // Override console.log to capture messages
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            const consoleOutput = document.getElementById('console-output');
            
            function addConsoleMessage(type, message) {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
                consoleOutput.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                addConsoleMessage('log', args.join(' '));
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                addConsoleMessage('error', args.join(' '));
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                addConsoleMessage('warn', args.join(' '));
            };
        }
        
        async function simulateProgressPolling() {
            console.log('üîÑ Simulating progress polling scenario...');
            
            // This simulates what happens when progress polling succeeds with 100% completion
            const mockResult = {
                simulation_id: 'test-progress-' + Date.now(),
                success: true,
                message: 'Simulation completed',
                data: {
                    interviews: Array(20).fill(null).map((_, i) => ({ id: i, content: 'Mock interview' }))
                }
            };
            
            // Simulate the localStorage saving from progress polling success
            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const newSimulationEntry = {
                simulation_id: mockResult.simulation_id,
                timestamp: new Date().toISOString(),
                results: mockResult,
                source: 'polling_completion'
            };
            existingResults.push(newSimulationEntry);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
            
            console.log('üíæ Saved mock simulation from progress polling:', mockResult.simulation_id);
            debugSimulationFlow(); // Refresh display
        }
        
        async function simulate404Handling() {
            console.log('üîÑ Simulating 404 handling scenario...');
            
            // This simulates what happens when progress polling gets 404 and fetches from completed endpoint
            const simulationId = '36a513fc-86e3-4491-b41e-ce188b297783';
            
            try {
                console.log('üì° Fetching from completed endpoint...');
                const resultResponse = await fetch(\`http://localhost:8000/api/research/simulation-bridge/completed/\${simulationId}\`);
                
                if (resultResponse.ok) {
                    const result = await resultResponse.json();
                    console.log('‚úÖ Successfully fetched completed simulation:', result.simulation_id);
                    
                    // Simulate the localStorage saving from 404 handler
                    const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const newSimulationEntry = {
                        simulation_id: result.simulation_id || simulationId,
                        timestamp: new Date().toISOString(),
                        results: result,
                        source: '404_completion'
                    };
                    existingResults.push(newSimulationEntry);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
                    
                    console.log('üíæ Saved simulation from 404 handler:', result.simulation_id || simulationId);
                    debugSimulationFlow(); // Refresh display
                } else {
                    console.error('‚ùå Failed to fetch completed simulation:', resultResponse.status);
                }
            } catch (error) {
                console.error('‚ùå Error in 404 handling simulation:', error.message);
            }
        }
        
        async function testHistoryPageLoading() {
            console.log('üîÑ Testing history page loading logic...');
            
            // Simulate the history page loading logic
            const localStorageData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            console.log('üì± LocalStorage data for history page:', localStorageData);
            
            const allSimulations = new Map();
            
            localStorageData.forEach((localSim, index) => {
                console.log(\`üîç Processing localStorage item \${index}:\`, localSim);
                const simId = localSim.simulation_id || localSim.results?.simulation_id;
                console.log(\`üîç Extracted simulation ID: \${simId}\`);
                
                if (simId) {
                    allSimulations.set(simId, {
                        source: 'localStorage',
                        data: localSim
                    });
                    console.log(\`‚úÖ Added simulation \${simId} from localStorage\`);
                } else {
                    console.warn(\`‚ö†Ô∏è No simulation ID found in localStorage item \${index}:\`, localSim);
                }
            });
            
            console.log('üîÑ Combined simulations for history page:', Array.from(allSimulations.keys()));
            
            if (allSimulations.size === 0) {
                console.error('‚ùå No simulations would be displayed in history page!');
            } else {
                console.log(\`‚úÖ \${allSimulations.size} simulations would be displayed in history page\`);
            }
        }
        
        function testSimulationInHistory(simulationId) {
            // Open history page and highlight the specific simulation
            const url = \`/unified-dashboard/simulation-history?highlight=\${simulationId}\`;
            window.open(url, '_blank');
        }
        
        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            console.log('üóëÔ∏è Cleared simulation storage');
            debugSimulationFlow(); // Refresh display
        }
        
        // Run debug on page load
        debugSimulationFlow();
    </script>
</body>
</html>
