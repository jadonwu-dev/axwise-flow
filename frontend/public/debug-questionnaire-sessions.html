<!DOCTYPE html>
<html>
<head>
    <title>Debug Questionnaire Sessions</title>
</head>
<body>
    <h1>Questionnaire Sessions Debug</h1>
    <div id="output"></div>
    
    <script>
        const STORAGE_KEY = 'axwise_research_sessions';
        
        function debugQuestionnaireSessions() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîç QUESTIONNAIRE SESSIONS DEBUG</h2>
                <p><strong>Storage Key:</strong> ${STORAGE_KEY}</p>
            `;
            
            // Check localStorage
            const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const sessionIds = Object.keys(sessions);
            
            output.innerHTML += `
                <h3>üìä Sessions Overview:</h3>
                <p><strong>Total Sessions:</strong> ${sessionIds.length}</p>
            `;
            
            // Analyze each session
            sessionIds.forEach((sessionKey, index) => {
                const session = sessions[sessionKey];
                const sessionId = session.session_id;
                
                // Check for questionnaire data
                const questionnaireMessage = session.messages?.find((msg) =>
                    msg.metadata?.comprehensiveQuestions
                );
                
                const hasNewFormat = !!questionnaireMessage?.metadata?.comprehensiveQuestions;
                const hasOldFormat = session.messages?.some((msg) => 
                    msg.content?.includes('COMPREHENSIVE_QUESTIONS_COMPONENT') ||
                    msg.metadata?.questions ||
                    msg.metadata?.stakeholders
                );
                
                let status = 'No Questionnaire';
                let statusColor = '#ff6b6b';
                
                if (hasNewFormat) {
                    status = 'New Format ‚úÖ';
                    statusColor = '#51cf66';
                } else if (hasOldFormat) {
                    status = 'Old Format ‚ö†Ô∏è';
                    statusColor = '#ffd43b';
                }
                
                output.innerHTML += `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; background: #f9f9f9;">
                        <h4>${index + 1}. ${sessionId}</h4>
                        <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${status}</span></p>
                        <p><strong>Business Idea:</strong> ${session.business_idea || 'None'}</p>
                        <p><strong>Target Customer:</strong> ${session.target_customer || 'None'}</p>
                        <p><strong>Problem:</strong> ${session.problem || 'None'}</p>
                        <p><strong>Messages:</strong> ${session.messages?.length || 0}</p>
                        <p><strong>Questions Generated:</strong> ${session.questions_generated ? 'Yes' : 'No'}</p>
                        
                        ${hasNewFormat ? `
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h5>‚úÖ New Format Details:</h5>
                                <p><strong>Primary Stakeholders:</strong> ${questionnaireMessage.metadata.comprehensiveQuestions.primaryStakeholders?.length || 0}</p>
                                <p><strong>Secondary Stakeholders:</strong> ${questionnaireMessage.metadata.comprehensiveQuestions.secondaryStakeholders?.length || 0}</p>
                                <p><strong>Total Questions:</strong> ${questionnaireMessage.metadata.comprehensiveQuestions.timeEstimate?.totalQuestions || 0}</p>
                                <button onclick="testSimulation('${sessionId}')">Test Simulation</button>
                                <button onclick="showSessionData('${sessionId}')">Show Data</button>
                            </div>
                        ` : hasOldFormat ? `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h5>‚ö†Ô∏è Old Format - Incompatible</h5>
                                <p>This session uses an outdated format and cannot be used for batch simulations.</p>
                                <button onclick="showSessionData('${sessionId}')">Show Data</button>
                            </div>
                        ` : `
                            <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h5>‚ùå No Questionnaire Data</h5>
                                <p>This session doesn't contain questionnaire data.</p>
                            </div>
                        `}
                    </div>
                `;
            });
            
            // Add test actions
            output.innerHTML += `
                <h3>üß™ Test Actions:</h3>
                <button onclick="clearSessions()">Clear All Sessions</button>
                <button onclick="window.location.reload()">Refresh Page</button>
                <button onclick="window.open('/unified-dashboard/research', '_blank')">Open Research Page</button>
            `;
        }
        
        async function testSimulation(sessionId) {
            try {
                const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                const session = Object.values(sessions).find(s => s.session_id === sessionId);
                
                if (!session) {
                    alert('‚ùå Session not found');
                    return;
                }
                
                // Extract questionnaire data
                const questionnaireMessage = session.messages?.find((msg) =>
                    msg.metadata?.comprehensiveQuestions
                );
                
                if (!questionnaireMessage) {
                    alert('‚ùå No questionnaire data found');
                    return;
                }
                
                const rawQuestionnaireData = questionnaireMessage.metadata.comprehensiveQuestions;
                
                // Transform data (same logic as in research page)
                const transformStakeholder = (stakeholder, index) => ({
                    id: stakeholder.id || \`stakeholder_\${index}\`,
                    name: stakeholder.name || stakeholder.title || \`Stakeholder \${index + 1}\`,
                    description: stakeholder.description || stakeholder.role || '',
                    questions: [
                        ...(stakeholder.questions?.problemDiscovery || []),
                        ...(stakeholder.questions?.solutionValidation || []),
                        ...(stakeholder.questions?.followUp || [])
                    ]
                });
                
                const questionnaireData = {
                    stakeholders: {
                        primary: (rawQuestionnaireData.primaryStakeholders || []).map(transformStakeholder),
                        secondary: (rawQuestionnaireData.secondaryStakeholders || []).map(transformStakeholder)
                    },
                    timeEstimate: rawQuestionnaireData.timeEstimate || { totalQuestions: 0 }
                };
                
                const businessContext = {
                    business_idea: session.business_idea || '',
                    target_customer: session.target_customer || '',
                    problem: session.problem || '',
                    industry: session.industry || 'general'
                };
                
                const config = {
                    depth: "detailed",
                    people_per_stakeholder: 5,
                    response_style: "realistic",
                    include_insights: false,
                    temperature: 0.7
                };
                
                const requestData = {
                    questions_data: questionnaireData,
                    business_context: businessContext,
                    config: config
                };
                
                console.log('üß™ Test simulation data:', requestData);
                
                // Test the API call
                const response = await fetch('http://localhost:8000/api/research/simulation-bridge/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(\`‚úÖ Simulation test successful!\nSimulation ID: \${result.simulation_id}\`);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert(\`‚ùå Simulation test failed (\${response.status}):\n\${errorData.detail || response.statusText}\`);
                }
                
            } catch (error) {
                alert(\`‚ùå Test error: \${error.message}\`);
            }
        }
        
        function showSessionData(sessionId) {
            const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const session = Object.values(sessions).find(s => s.session_id === sessionId);
            
            if (session) {
                const popup = window.open('', '_blank', 'width=800,height=600');
                popup.document.write(\`
                    <html>
                        <head><title>Session Data: \${sessionId}</title></head>
                        <body>
                            <h1>Session Data: \${sessionId}</h1>
                            <pre>\${JSON.stringify(session, null, 2)}</pre>
                        </body>
                    </html>
                \`);
            }
        }
        
        function clearSessions() {
            if (confirm('Clear all questionnaire sessions?')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('‚úÖ Sessions cleared');
                debugQuestionnaireSessions(); // Refresh
            }
        }
        
        // Run debug on page load
        debugQuestionnaireSessions();
    </script>
</body>
</html>
