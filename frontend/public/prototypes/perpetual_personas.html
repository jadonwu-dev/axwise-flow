<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AxWise Flow ‚Äî Perpetual Personas (HTML Prototype)</title>
  <style>
    :root{--bg:#0b1120;--panel:#0f172a;--muted:#334155;--text:#e5e7eb;--accent:#22c55e;--cta:#3b82f6}
    *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto;color:var(--text);background:linear-gradient(180deg,#0a0f1f,#0b1120)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{font-weight:700;font-size:18px;letter-spacing:.3px}
    .note{opacity:.75;font-size:12px}
    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .pipeline{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:0 0 14px 0;padding:0;list-style:none}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--muted);background:#0b1224;font-size:12px;white-space:nowrap}
    .chip.done{border-color:var(--accent);color:var(--accent);background:#0e1b2d}
    .arrow{opacity:.5}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    button{background:var(--cta);border:0;color:white;padding:8px 10px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer}
    button.secondary{background:#1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .head{display:flex;gap:12px;align-items:center}
    .avatar{width:72px;height:72px;border-radius:12px;border:none;object-fit:cover;background:transparent;opacity:0.95}
    .meta b{display:block;font-size:14px}
    .meta span{font-size:12px;opacity:.8}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .video{display:none;height:120px;border-radius:10px;border:1px dashed var(--muted);align-items:center;justify-content:center;color:#9ca3af;background:repeating-linear-gradient(45deg,#0e1726,#0e1726 10px,#0d1420 10px,#0d1420 20px)}
    .video.ready{display:flex;cursor:pointer}
    .bubble{display:none;background:rgba(59,130,246,0.08);border-left:3px solid #3b82f6;padding:8px 12px;border-radius:6px;font-size:12px;font-style:italic;color:#cbd5e1;line-height:1.5;margin-top:8px}
    .bubble.show{display:block}
    footer{opacity:.7;margin-top:14px;font-size:12px}
    .progress{display:none;height:8px;background:#0b1224;border:1px solid var(--muted);border-radius:999px;overflow:hidden;margin-top:6px}
    .progress.show{display:block}
    .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#3b82f6);transition:width .4s ease}

    /* Context and Preference styles */
    .contexts-section{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .context-group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .context-label{font-size:11px;opacity:0.7;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;min-width:80px}
    .context-item{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid}
    .context-item.active{opacity:1}
    .context-item.inactive{opacity:0.4}
    .context-item.dining{background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.3);color:#a78bfa}
    .context-item.takeaway{background:rgba(251,146,60,0.1);border-color:rgba(251,146,60,0.3);color:#fb923c}
    .check-icon{font-size:10px;font-weight:700}

    .preferences-section{margin-top:8px}
    .pref-group{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .pref-label{font-size:11px;opacity:0.7;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;min-width:80px}
    .pref-tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:500;white-space:nowrap;border:1px solid}
    .pref-tag{background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.3);color:#4ade80}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">AxWise Flow ‚Äî Perpetual Personas</div>
      <div class="note">Static HTML prototype ‚Äî simulates generation without backend</div>
    </header>

    <section class="panel">
      <ol class="pipeline">
        <li class="chip done">Upload Transcripts</li><span class="arrow">‚Üí</span>
        <li class="chip done">Theme Extraction</li><span class="arrow">‚Üí</span>
        <li class="chip done">Pattern Recognition</li><span class="arrow">‚Üí</span>
        <li class="chip done">Persona Formation</li><span class="arrow">‚Üí</span>
        <li class="chip">PRD</li>
      </ol>
      <div class="toolbar">
        <button id="gen-all-avatars">Generate all avatars</button>
        <button id="gen-all-profiles" class="secondary">Generate city profiles</button>
      </div>
    </section>
    <section class="panel" aria-label="Backend Config">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label><input type="checkbox" id="useBackend"> Use backend</label>
        <label>Analysis <select id="resultSelect" style="width:280px;background:#0b1224;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:6px 8px"><option value="">Loading‚Ä¶</option></select></label>
        <button id="refreshResults" class="secondary" style="padding:6px 10px">Refresh</button>
        <label>Location <input type="text" id="cityInput" value="Berlin" placeholder="Berlin, Munich, Paris..." style="width:180px;background:#0b1224;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:6px 8px"></label>
        <label>Token <input type="text" id="token" value="dev_test_token_testuser123" style="width:220px;background:#0b1224;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:6px 8px"></label>
        <label>Server <input type="text" id="server" value="http://localhost:8000" style="width:240px;background:#0b1224;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:6px 8px"></label>

        <span class="note">When enabled, buttons call /api/personas/{result_id}/{persona_id}/‚Ä¶</span>
      </div>
    </section>


    <div class="grid" id="cards">
      <div class="card" data-id="sarah">
        <div class="head">
          <img class="avatar" alt="avatar" src="https://placehold.co/72x72?text=?" />
          <div class="meta"><b>Sarah Chen</b><span>VP Strategy ‚Ä¢ Enterprise</span></div>
        </div>
        <div class="actions">
          <button data-action="avatar">Generate avatar</button>
          <button data-action="profile" class="secondary">Berlin profile</button>
          <button data-action="quote" class="secondary">Extract quote</button>
        </div>
        <div class="berlin-info" style="display:none;margin-top:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px"></div>
        <div class="bubble">‚ÄúHi, I'm Sarah. My biggest challenge is manual cross-department alignment.‚Äù</div>
      </div>

      <div class="card" data-id="dmitri">
        <div class="head">
          <img class="avatar" alt="avatar" src="https://placehold.co/72x72?text=?" />
          <div class="meta"><b>Dmitri Volkov</b><span>CTO ‚Ä¢ Mid‚Äëmarket</span></div>
        </div>
        <div class="actions">
          <button data-action="avatar">Generate avatar</button>
          <button data-action="profile" class="secondary">Berlin profile</button>
          <button data-action="quote" class="secondary">Extract quote</button>
        </div>
        <div class="berlin-info" style="display:none;margin-top:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px"></div>
        <div class="bubble">‚ÄúSecurity and ROI in the first demo are must‚Äëhaves for us.‚Äù</div>
      </div>

      <div class="card" data-id="amira">
        <div class="head">
          <img class="avatar" alt="avatar" src="https://placehold.co/72x72?text=?" />
          <div class="meta"><b>Amira Hassan</b><span>Head of Procurement ‚Ä¢ Enterprise</span></div>
        </div>
        <div class="actions">
          <button data-action="avatar">Generate avatar</button>
          <button data-action="profile" class="secondary">Berlin profile</button>
          <button data-action="quote" class="secondary">Extract quote</button>
        </div>
        <div class="berlin-info" style="display:none;margin-top:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px"></div>
        <div class="bubble">‚ÄúWe need 18‚Äëmonth ROI visibility and vendor compliance early.‚Äù</div>
      </div>
    </div>

    <footer>Photorealistic 85mm headshots with Berlin profiles and meaningful quotes from analysis.</footer>
  </div>

  <script>
    const wait = ms => new Promise(r=>setTimeout(r,ms));
    const cfg = { useBackend:false, resultId:'', token:'' };
    function setLoading(btn, on, txt){ if(on){ btn.dataset.prev=btn.textContent; btn.textContent=txt; btn.disabled=true; } else { btn.textContent=btn.dataset.prev||btn.textContent; btn.disabled=false; } }
    function getPersonaName(card){ return (card.querySelector('.meta b')?.textContent||card.dataset.id); }

    // Load personas from backend when analysis is selected
    async function loadPersonasFromBackend(resultId){
      if(!resultId) return;
      const cardsContainer = document.getElementById('cards');
      cardsContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#9ca3af">Loading personas...</div>';
      try{
        const r = await fetch(`${(cfg.baseUrl||'http://localhost:8000').replace(/\/+$/,'')}/api/personas/results`, {
          headers:{'Authorization':'Bearer '+(cfg.token||'dev_test_token_testuser123')}
        });
        const data = await r.json();
        const analysis = (data.items||[]).find(i => i.result_id == resultId);
        if(!analysis || !analysis.personas || analysis.personas.length === 0){
          cardsContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#9ca3af">No personas found for this analysis</div>';
          return;
        }
        // Build persona cards
        const palette=['#7c3aed','#06b6d4','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6'];
        cardsContainer.innerHTML = analysis.personas.map((p, idx) => {
          const personaId = p.id || String(idx);
          const personaName = p.name || `Persona ${idx}`;
          const personaTitle = p.title || 'No title';
          const col = palette[idx % palette.length];
          return `
            <div class="card" data-id="${personaId}">
              <div class="head">
                <img class="avatar" alt="avatar" src="https://placehold.co/72x72?text=?" style="border:none;box-shadow:none" />
                <div class="meta"><b>${personaName}</b><span>${personaTitle}</span></div>
              </div>
              <div class="actions">
                <button data-action="avatar">Regenerate avatar</button>
                <button data-action="profile" class="secondary">City profile</button>
                <button data-action="quote" class="secondary">Extract quote</button>
              </div>
              <div class="bubble">${personaName} persona quote will appear here.</div>
              <div class="berlin-info" style="display:none;margin-top:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px"></div>
            </div>
          `;
        }).join('');
      }catch(e){
        cardsContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444">Error loading personas: '+e.message+'</div>';
      }
    }

    async function genAvatar(card, btn){
      setLoading(btn,true,'Generating avatar‚Ä¶');
      const img=card.querySelector('.avatar');
      let ok=false;
      if(cfg.useBackend && cfg.resultId){
        try{
          const r = await fetch(`${(cfg.baseUrl||'http://localhost:8000').replace(/\/+$/,'')}/api/personas/${encodeURIComponent(cfg.resultId)}/${encodeURIComponent(card.dataset.id)}/avatar`, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':'Bearer '+(cfg.token||'dev_test_token_testuser123')},
            body: JSON.stringify({ style_pack:{ name:getPersonaName(card), style_desc:'distinctive editorial color grade, rim light, depth, characterful' } })
          });
          if(r.ok){ const data = await r.json(); if(data.avatar_data_uri||data.avatar_url){ img.src = data.avatar_data_uri || data.avatar_url; ok=true; } }
        }catch(_e){}
      }
      if(!ok){
        await wait(900);
        img.src='https://placehold.co/160x160?text=Avatar';
      }
      img.style.width='96px'; img.style.height='96px';
      setLoading(btn,false); btn.textContent='Regenerate avatar';
    }



    async function genProfile(card, btn){
      const box=card.querySelector('.berlin-info');
      const cityInput = document.getElementById('cityInput');
      const city = cityInput?.value?.trim() || 'Berlin';

      if(!(cfg.useBackend && cfg.resultId)) {
        box.style.display='block';
        box.innerHTML=`<strong>${city} Profile</strong><br/>Enable backend to generate`;
        return;
      }
      try{
        setLoading(btn,true,'Generating‚Ä¶');
        const r = await fetch(`${(cfg.baseUrl||'http://localhost:8000').replace(/\/+$/,'')}/api/personas/${encodeURIComponent(cfg.resultId)}/${encodeURIComponent(card.dataset.id)}/city-profile`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+(cfg.token||'dev_test_token_testuser123')},
          body: JSON.stringify({ city: city })
        });
        if(r.ok){
          const data=await r.json();
          const bp=data.city_profile||data.berlin_profile||{};

          // Build comprehensive food profile display
          let html=`<strong>üìç ${bp.city||city}</strong>`;
          if(bp.neighborhood) html+=` ‚Ä¢ ${bp.neighborhood}`;
          if(bp.district) html+=` (${bp.district})`;
          html+=`<br/>`;

          if(bp.origin_description) {
            html+=`<small style="opacity:0.8">${bp.origin_description}</small><br/>`;
          }

          // Display dining and takeaway contexts with probability filtering
          const diningCtx = bp.dining_context || {};
          const takeawayCtx = bp.takeaway_context || {};
          const foodBevPrefs = bp.food_beverage_preferences || [];

          const THRESHOLD = 70; // Only show options with ‚â•70% probability

          // Filter and sort dining context options
          const diningOptions = [
            { name: 'Solo', value: diningCtx.solo },
            { name: 'Social', value: diningCtx.social },
            { name: 'Business', value: diningCtx.business }
          ].filter(opt => opt.value >= THRESHOLD)
           .sort((a, b) => b.value - a.value); // Sort by probability descending

          // Filter and sort takeaway context options
          const takeawayOptions = [
            { name: 'Pickup', value: takeawayCtx.pickup },
            { name: 'Home Delivery', value: takeawayCtx.delivery_home },
            { name: 'Office Delivery', value: takeawayCtx.delivery_office }
          ].filter(opt => opt.value >= THRESHOLD)
           .sort((a, b) => b.value - a.value); // Sort by probability descending

          if(diningOptions.length > 0 || takeawayOptions.length > 0 || foodBevPrefs.length > 0) {
            html+=`<div class="contexts-section">`;

            // Dining context - only show high-probability options
            if(diningOptions.length > 0) {
              html+=`<div class="context-group">`;
              html+=`<span class="context-label">Dine-in:</span>`;

              diningOptions.forEach(opt => {
                html+=`<span class="context-item dining active"><span class="check-icon">‚úì</span> ${opt.name} (${opt.value}%)</span>`;
              });
              html+=`</div>`;
            }

            // Takeaway context - only show high-probability options
            if(takeawayOptions.length > 0) {
              html+=`<div class="context-group">`;
              html+=`<span class="context-label">Takeaway:</span>`;

              takeawayOptions.forEach(opt => {
                html+=`<span class="context-item takeaway active"><span class="check-icon">‚úì</span> ${opt.name} (${opt.value}%)</span>`;
              });
              html+=`</div>`;
            }

            html+=`</div>`;
          }

          // Display food & beverage preferences
          if(foodBevPrefs.length > 0) {
            html+=`<div class="preferences-section">`;
            html+=`<div class="pref-group">`;
            html+=`<span class="pref-label">Preferences:</span>`;
            foodBevPrefs.forEach(pref => {
              html+=`<span class="pref-tag">${pref}</span>`;
            });
            html+=`</div>`;
            html+=`</div>`;
          }

          const lunch=bp.lunch?.nearby_recommendations||[];
          const dinner=bp.dinner?.nearby_recommendations||[];

          if(lunch.length>0) {
            html+=`<br/><strong>üçΩÔ∏è Lunch:</strong><br/>`;
            lunch.slice(0,2).forEach(r=>{
              html+=`<small><strong>‚Ä¢ ${r.name}</strong> <span style="opacity:0.7">(${r.type}${r.area?', '+r.area:''})</span></small><br/>`;
              if(r.typical_order) html+=`<small style="opacity:0.8;margin-left:12px">‚Üí ${r.typical_order}</small><br/>`;
              if(r.drink) html+=`<small style="opacity:0.7;margin-left:12px">ü•§ ${r.drink}</small><br/>`;
            });
          }

          if(dinner.length>0) {
            html+=`<br/><strong>üç∑ Dinner:</strong><br/>`;
            dinner.slice(0,2).forEach(r=>{
              html+=`<small><strong>‚Ä¢ ${r.name}</strong> <span style="opacity:0.7">(${r.type}${r.area?', '+r.area:''})</span></small><br/>`;
              if(r.typical_order) html+=`<small style="opacity:0.8;margin-left:12px">‚Üí ${r.typical_order}</small><br/>`;
              if(r.drink) html+=`<small style="opacity:0.7;margin-left:12px">üç∑ ${r.drink}</small><br/>`;
            });
          }

          box.innerHTML=html;
          box.style.display='block';
        }
      }catch(_e){
        console.error('Profile generation error:', _e);
        box.style.display='block';
        box.innerHTML='<span style="color:#ef4444">Error generating profile</span>';
      }
      finally{ setLoading(btn,false); }
    }

    async function genQuote(card, btn){
      const b=card.querySelector('.bubble');
      if(!(cfg.useBackend && cfg.resultId)) { b.classList.toggle('show'); return; }
      try{
        setLoading(btn,true,'Extracting‚Ä¶');
        const r = await fetch(`${(cfg.baseUrl||'http://localhost:8000').replace(/\/+$/,'')}/api/personas/${encodeURIComponent(cfg.resultId)}/${encodeURIComponent(card.dataset.id)}/quote`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+(cfg.token||'dev_test_token_testuser123')},
          body: JSON.stringify({})
        });
        if(r.ok){ const data=await r.json(); if(data.quote){ b.textContent=data.quote; } }
        b.classList.toggle('show');
      }catch(_e){ b.classList.toggle('show'); }
      finally{ setLoading(btn,false); }
    }

    document.getElementById('cards').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button');
      const card=e.target.closest('.card');
      if(!btn || !card) return; const act=btn.dataset.action;
      if(act==='avatar') await genAvatar(card,btn);
      if(act==='profile') await genProfile(card,btn);
      if(act==='quote') await genQuote(card,btn);
    });

    document.getElementById('gen-all-avatars').addEventListener('click', async ()=>{
      for(const btn of document.querySelectorAll('[data-action="avatar"]')){ const card=btn.closest('.card'); await genAvatar(card,btn); }
    });
    document.getElementById('gen-all-profiles').addEventListener('click', async ()=>{
      for(const btn of document.querySelectorAll('[data-action="profile"]')){ const card=btn.closest('.card'); await genProfile(card,btn); }
    });

    window.addEventListener('DOMContentLoaded',()=>{
      const use=document.getElementById('useBackend'); const sel=document.getElementById('resultSelect'); const tok=document.getElementById('token'); const srv=document.getElementById('server');
      const apply=()=>{
        cfg.useBackend=!!use?.checked;
        cfg.resultId=(sel?.value||'').trim();
        cfg.token=(tok?.value||'').trim();
        cfg.baseUrl=(srv?.value||'http://localhost:8000').trim().replace(/\/+$/,'');
        // Load personas when analysis is selected and backend is enabled
        if(cfg.useBackend && cfg.resultId){
          loadPersonasFromBackend(cfg.resultId);
        }
      };
      [use,tok,srv].forEach(el=> el && el.addEventListener('input', apply));
      if(sel){ sel.addEventListener('change', apply); }
      async function loadResultsChoices(){ if(!sel) return; sel.innerHTML='<option value="">Loading‚Ä¶</option>'; try{ const r=await fetch(`${(cfg.baseUrl||'http://localhost:8000').replace(/\/+$/,'')}/api/personas/results`,{ headers:{'Authorization':'Bearer '+(tok?.value||'dev_test_token_testuser123')} }); const data=await r.json(); const items=data.items||[]; if(items.length===0){ sel.innerHTML='<option value="">No analyses found</option>'; } else { sel.innerHTML='<option value="">Select analysis/persona pack‚Ä¶</option>'+ items.map(i=>`<option value="${i.result_id}">${(i.label||('Result '+i.result_id))}</option>`).join(''); } }catch(e){ sel.innerHTML='<option value="">Error loading analyses</option>'; } }
      const refresh=document.getElementById('refreshResults'); if(refresh){ refresh.addEventListener('click', ()=> loadResultsChoices()); }
      // Unique accent per persona (deterministic but distinct)
      const palette=['#7c3aed','#06b6d4','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6'];
      document.querySelectorAll('.card').forEach(c=>{ const av=c.querySelector('.avatar'); if(av){ av.style.border='none'; av.style.boxShadow='none'; }});
      loadResultsChoices(); apply();
    });
  </script>
</body>
</html>

