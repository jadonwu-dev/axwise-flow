<!DOCTYPE html>
<html>
<head>
    <title>Find API Service Interviews</title>
</head>
<body>
    <h1>Find API Service Simulated Interviews</h1>
    <div id="output"></div>
    
    <script>
        const SIMULATION_STORAGE_KEY = 'simulation_results';
        const SESSION_STORAGE_KEY = 'axwise_research_sessions';
        
        function findApiServiceInterviews() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîç SEARCHING FOR API SERVICE INTERVIEWS</h2>
                <p>Looking for simulated interviews related to "API service to pull legacy sales order data"</p>
            `;
            
            // Check simulation results storage
            const simulationResults = JSON.parse(localStorage.getItem(SIMULATION_STORAGE_KEY) || '[]');
            
            output.innerHTML += `
                <h3>üìä Simulation Results Storage:</h3>
                <p><strong>Total Simulations:</strong> ${simulationResults.length}</p>
            `;
            
            if (simulationResults.length === 0) {
                output.innerHTML += `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚ùå No Simulation Results Found</h4>
                        <p>No simulations found in localStorage under '${SIMULATION_STORAGE_KEY}'</p>
                    </div>
                `;
            } else {
                // Search through all simulations for API service related content
                let apiServiceSimulations = [];
                
                simulationResults.forEach((sim, index) => {
                    const simId = sim.simulation_id || sim.results?.simulation_id || 'Unknown';
                    const businessIdea = sim.results?.business_context?.business_idea || 
                                       sim.results?.data?.business_context?.business_idea || 
                                       'Unknown';
                    const interviews = sim.results?.interviews || 
                                     sim.results?.data?.interviews || 
                                     [];
                    
                    // Check if this simulation is related to API service
                    const isApiService = businessIdea.toLowerCase().includes('api') || 
                                        businessIdea.toLowerCase().includes('legacy') ||
                                        businessIdea.toLowerCase().includes('sales order');
                    
                    if (isApiService) {
                        apiServiceSimulations.push({
                            index: index,
                            simulation_id: simId,
                            business_idea: businessIdea,
                            interviews: interviews,
                            timestamp: sim.timestamp,
                            source: sim.source
                        });
                    }
                    
                    // Show all simulations for reference
                    output.innerHTML += `
                        <div style="border: 1px solid ${isApiService ? '#28a745' : '#ddd'}; margin: 10px 0; padding: 15px; background: ${isApiService ? '#e8f5e8' : '#f9f9f9'};">
                            <h4>${index + 1}. ${simId} ${isApiService ? 'üéØ API SERVICE' : ''}</h4>
                            <p><strong>Business Idea:</strong> ${businessIdea}</p>
                            <p><strong>Interviews:</strong> ${interviews.length}</p>
                            <p><strong>Timestamp:</strong> ${sim.timestamp ? new Date(sim.timestamp).toLocaleString() : 'Unknown'}</p>
                            <p><strong>Source:</strong> ${sim.source || 'Unknown'}</p>
                            
                            ${interviews.length > 0 ? `
                                <button onclick="showInterviews('${simId}', ${index})">Show Interviews</button>
                                <button onclick="downloadInterviews('${simId}', ${index})">Download Interviews</button>
                            ` : ''}
                        </div>
                    `;
                });
                
                if (apiServiceSimulations.length > 0) {
                    output.innerHTML += `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h3>‚úÖ Found ${apiServiceSimulations.length} API Service Simulation(s)</h3>
                            ${apiServiceSimulations.map(sim => `
                                <p><strong>${sim.simulation_id}:</strong> ${sim.interviews.length} interviews (${sim.source})</p>
                            `).join('')}
                        </div>
                    `;
                } else {
                    output.innerHTML += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h4>‚ö†Ô∏è No API Service Simulations Found</h4>
                            <p>None of the stored simulations appear to be related to API service.</p>
                        </div>
                    `;
                }
            }
            
            // Also check session storage for context
            const sessions = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '{}');
            const apiServiceSessions = Object.values(sessions).filter(session => 
                session.business_idea && (
                    session.business_idea.toLowerCase().includes('api') ||
                    session.business_idea.toLowerCase().includes('legacy') ||
                    session.business_idea.toLowerCase().includes('sales order')
                )
            );
            
            output.innerHTML += `
                <h3>üìã Related Sessions:</h3>
                <p><strong>API Service Sessions Found:</strong> ${apiServiceSessions.length}</p>
            `;
            
            apiServiceSessions.forEach(session => {
                output.innerHTML += `
                    <div style="border: 1px solid #007bff; margin: 10px 0; padding: 15px; background: #f0f8ff;">
                        <h4>Session: ${session.session_id}</h4>
                        <p><strong>Business Idea:</strong> ${session.business_idea}</p>
                        <p><strong>Questions Generated:</strong> ${session.questions_generated ? 'Yes' : 'No'}</p>
                        <button onclick="checkSessionForSimulations('${session.session_id}')">Check for Simulations</button>
                    </div>
                `;
            });
            
            // Add action buttons
            output.innerHTML += `
                <h3>üîß Actions:</h3>
                <button onclick="window.open('/unified-dashboard/simulation-history', '_blank')">Open Simulation History</button>
                <button onclick="searchAllStorageKeys()">Search All Storage Keys</button>
                <button onclick="findApiServiceInterviews()">Refresh Search</button>
            `;
        }
        
        function showInterviews(simulationId, index) {
            const simulationResults = JSON.parse(localStorage.getItem(SIMULATION_STORAGE_KEY) || '[]');
            const simulation = simulationResults[index];
            
            if (!simulation) {
                alert('‚ùå Simulation not found');
                return;
            }
            
            const interviews = simulation.results?.interviews || simulation.results?.data?.interviews || [];
            
            if (interviews.length === 0) {
                alert('‚ùå No interviews found in this simulation');
                return;
            }
            
            // Open popup with interviews
            const popup = window.open('', '_blank', 'width=1000,height=700');
            popup.document.write(`
                <html>
                    <head><title>Interviews: ${simulationId}</title></head>
                    <body>
                        <h1>Interviews for ${simulationId}</h1>
                        <p><strong>Total Interviews:</strong> ${interviews.length}</p>
                        <hr>
                        ${interviews.map((interview, i) => `
                            <div style="border: 1px solid #ddd; margin: 20px 0; padding: 15px;">
                                <h3>Interview ${i + 1}</h3>
                                <p><strong>Stakeholder:</strong> ${interview.stakeholder_type || 'Unknown'}</p>
                                <p><strong>Persona ID:</strong> ${interview.persona_id || 'Unknown'}</p>
                                <h4>Questions & Answers:</h4>
                                <pre style="white-space: pre-wrap; background: #f5f5f5; padding: 10px;">${JSON.stringify(interview.responses || interview.content || interview, null, 2)}</pre>
                            </div>
                        `).join('')}
                    </body>
                </html>
            `);
        }
        
        function downloadInterviews(simulationId, index) {
            const simulationResults = JSON.parse(localStorage.getItem(SIMULATION_STORAGE_KEY) || '[]');
            const simulation = simulationResults[index];
            
            if (!simulation) {
                alert('‚ùå Simulation not found');
                return;
            }
            
            const interviews = simulation.results?.interviews || simulation.results?.data?.interviews || [];
            const businessIdea = simulation.results?.business_context?.business_idea || 'Unknown Business';
            
            let content = `SIMULATION INTERVIEWS\n`;
            content += `=====================\n\n`;
            content += `Simulation ID: ${simulationId}\n`;
            content += `Business Idea: ${businessIdea}\n`;
            content += `Total Interviews: ${interviews.length}\n`;
            content += `Generated: ${simulation.timestamp ? new Date(simulation.timestamp).toLocaleString() : 'Unknown'}\n\n`;
            
            interviews.forEach((interview, i) => {
                content += `INTERVIEW ${i + 1}\n`;
                content += `================\n`;
                content += `Stakeholder: ${interview.stakeholder_type || 'Unknown'}\n`;
                content += `Persona ID: ${interview.persona_id || 'Unknown'}\n\n`;
                content += `Responses:\n`;
                content += JSON.stringify(interview.responses || interview.content || interview, null, 2);
                content += `\n\n`;
            });
            
            // Download as text file
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-service-interviews-${simulationId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Downloaded interviews for ${simulationId}`);
        }
        
        function checkSessionForSimulations(sessionId) {
            // Check if any simulations were created from this session
            const simulationResults = JSON.parse(localStorage.getItem(SIMULATION_STORAGE_KEY) || '[]');
            const relatedSimulations = simulationResults.filter(sim => {
                // This is tricky since we don't store session ID in simulation results
                // We'll have to match by business context
                const sessions = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '{}');
                const session = Object.values(sessions).find(s => s.session_id === sessionId);
                
                if (!session) return false;
                
                const simBusinessIdea = sim.results?.business_context?.business_idea || '';
                return simBusinessIdea === session.business_idea;
            });
            
            alert(`Found ${relatedSimulations.length} simulations that might be related to session ${sessionId}`);
        }
        
        function searchAllStorageKeys() {
            let allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('simulation') || key.includes('interview') || key.includes('api'))) {
                    allKeys.push(key);
                }
            }
            
            alert(`Found storage keys that might contain interviews:\n${allKeys.join('\n')}`);
        }
        
        // Run search on page load
        findApiServiceInterviews();
    </script>
</body>
</html>
