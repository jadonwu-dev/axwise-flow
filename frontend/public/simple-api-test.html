<!DOCTYPE html>
<html>
<head>
    <title>Simple API Service Test</title>
</head>
<body>
    <h1>Simple API Service Test</h1>
    <div id="output">Loading...</div>

    <script>
        console.log('Script starting...');

        function runTest() {
            console.log('runTest called');
            const output = document.getElementById('output');

            try {
                const TARGET_SESSION_ID = 'local_1753257997112_sea7vym8q';
                const sessions = JSON.parse(localStorage.getItem('axwise_research_sessions') || '{}');

                console.log('Sessions loaded:', Object.keys(sessions).length);

                output.innerHTML = `
                    <h2>API Service Session Test</h2>
                    <p><strong>Target Session:</strong> ${TARGET_SESSION_ID}</p>
                    <p><strong>Total Sessions:</strong> ${Object.keys(sessions).length}</p>
                `;

                // Find all sessions with API in business idea
                const apiSessions = Object.values(sessions).filter(s =>
                    s.business_idea && s.business_idea.toLowerCase().includes('api')
                );

                output.innerHTML += `<p><strong>API Sessions Found:</strong> ${apiSessions.length}</p>`;

                if (apiSessions.length > 0) {
                    output.innerHTML += '<h3>API Sessions:</h3><ul>';
                    apiSessions.forEach(session => {
                        output.innerHTML += `<li>${session.session_id}: ${session.business_idea}</li>`;
                    });
                    output.innerHTML += '</ul>';

                    // Add button to run simulation
                    output.innerHTML += `
                        <button onclick="runApiSimulation('${apiSessions[0].session_id}')"
                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0;">
                            Run Simulation for First API Session
                        </button>
                    `;
                } else {
                    output.innerHTML += '<p style="color: red;">No API sessions found</p>';

                    // Show all sessions for debugging
                    output.innerHTML += '<h3>All Sessions:</h3><ul>';
                    Object.values(sessions).forEach(session => {
                        output.innerHTML += `<li>${session.session_id}: ${session.business_idea || 'No business idea'}</li>`;
                    });
                    output.innerHTML += '</ul>';
                }

            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function runApiSimulation(sessionId) {
            console.log('Running simulation for:', sessionId);

            try {
                const sessions = JSON.parse(localStorage.getItem('axwise_research_sessions') || '{}');
                const session = Object.values(sessions).find(s => s.session_id === sessionId);

                if (!session) {
                    alert('Session not found');
                    return;
                }

                // Check if session has questionnaire
                const questionnaireMessage = session.messages?.find(msg =>
                    msg.metadata?.comprehensiveQuestions
                );

                if (!questionnaireMessage) {
                    alert('No questionnaire data found in this session');
                    return;
                }

                const questionnaire = questionnaireMessage.metadata.comprehensiveQuestions;

                console.log('üìã Raw questionnaire data:', questionnaire);
                console.log('‚è±Ô∏è Raw timeEstimate:', questionnaire.timeEstimate);

                // Transform data for API
                const transformStakeholder = (stakeholder, index) => ({
                    id: stakeholder.id || `stakeholder_${index}`,
                    name: stakeholder.name || stakeholder.title || `Stakeholder ${index + 1}`,
                    description: stakeholder.description || stakeholder.role || '',
                    questions: [
                        ...(stakeholder.questions?.problemDiscovery || []),
                        ...(stakeholder.questions?.solutionValidation || []),
                        ...(stakeholder.questions?.followUp || [])
                    ]
                });

                // Handle timeEstimate properly - it should be a dict or null
                let timeEstimate = null;
                if (questionnaire.timeEstimate) {
                    if (typeof questionnaire.timeEstimate === 'object') {
                        // Already an object, use as is
                        timeEstimate = questionnaire.timeEstimate;
                    } else if (typeof questionnaire.timeEstimate === 'string') {
                        // Convert string to object
                        timeEstimate = {
                            estimatedTime: questionnaire.timeEstimate,
                            totalQuestions: 0
                        };
                    }
                }

                const questionnaireData = {
                    stakeholders: {
                        primary: (questionnaire.primaryStakeholders || []).map(transformStakeholder),
                        secondary: (questionnaire.secondaryStakeholders || []).map(transformStakeholder)
                    },
                    timeEstimate: timeEstimate
                };

                const businessContext = {
                    business_idea: session.business_idea || '',
                    target_customer: session.target_customer || '',
                    problem: session.problem || '',
                    industry: 'general'
                };

                const config = {
                    depth: "detailed",
                    people_per_stakeholder: 5,
                    response_style: "realistic",
                    include_insights: false,
                    temperature: 0.7
                };

                // Validate data before sending
                console.log('üìä Validation Check:');
                console.log('Business Context:', businessContext);
                console.log('Primary Stakeholders:', questionnaireData.stakeholders.primary.length);
                console.log('Secondary Stakeholders:', questionnaireData.stakeholders.secondary.length);
                console.log('Config:', config);

                // Check for common validation issues
                if (!businessContext.business_idea) {
                    alert('‚ùå Missing business idea');
                    return;
                }
                if (!businessContext.target_customer) {
                    alert('‚ùå Missing target customer');
                    return;
                }
                if (!businessContext.problem) {
                    alert('‚ùå Missing problem');
                    return;
                }
                if (questionnaireData.stakeholders.primary.length === 0 && questionnaireData.stakeholders.secondary.length === 0) {
                    alert('‚ùå No stakeholders found');
                    return;
                }

                // Check stakeholder questions
                const allStakeholders = [...questionnaireData.stakeholders.primary, ...questionnaireData.stakeholders.secondary];
                for (let i = 0; i < allStakeholders.length; i++) {
                    const stakeholder = allStakeholders[i];
                    if (!stakeholder.name) {
                        alert(`‚ùå Stakeholder ${i + 1} missing name`);
                        return;
                    }
                    if (!stakeholder.questions || stakeholder.questions.length === 0) {
                        alert(`‚ùå Stakeholder "${stakeholder.name}" has no questions`);
                        return;
                    }
                }

                console.log('‚úÖ Validation passed, sending simulation request...');

                const response = await fetch('http://localhost:8000/api/research/simulation-bridge/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questions_data: questionnaireData,
                        business_context: businessContext,
                        config: config
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Simulation successful:', result);

                    // Save to localStorage
                    const existingResults = JSON.parse(localStorage.getItem('simulation_results') || '[]');
                    const newSimulationEntry = {
                        simulation_id: result.simulation_id,
                        timestamp: new Date().toISOString(),
                        results: result,
                        source: 'simple_api_test'
                    };
                    existingResults.push(newSimulationEntry);
                    localStorage.setItem('simulation_results', JSON.stringify(existingResults));

                    alert(`‚úÖ API Service Simulation Successful!\nSimulation ID: ${result.simulation_id}\nInterviews: ${(result.interviews || result.data?.interviews || []).length}\n\nCheck the simulation history page!`);

                } else {
                    let errorData = {};
                    try {
                        errorData = await response.json();
                    } catch (parseError) {
                        console.warn('Could not parse error response as JSON:', parseError);
                    }

                    console.error('Simulation failed:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData,
                        requestData: {
                            questions_data: questionnaireData,
                            business_context: businessContext,
                            config: config
                        }
                    });

                    // Create detailed error message
                    let errorMessage = `Simulation failed (${response.status})`;
                    if (errorData.detail) {
                        if (typeof errorData.detail === 'string') {
                            errorMessage = errorData.detail;
                        } else {
                            errorMessage = JSON.stringify(errorData.detail, null, 2);
                        }
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (response.status === 422) {
                        errorMessage = `Validation error (422). Check console for details.\n\nError data: ${JSON.stringify(errorData, null, 2)}`;
                    }

                    alert(`‚ùå ${errorMessage}`);
                }

            } catch (error) {
                console.error('Simulation error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Run when page loads
        document.addEventListener('DOMContentLoaded', runTest);

        // Also run immediately in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded');
        } else {
            console.log('Document already loaded, running test immediately');
            runTest();
        }
    </script>
</body>
</html>
