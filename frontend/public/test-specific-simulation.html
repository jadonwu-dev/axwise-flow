<!DOCTYPE html>
<html>
<head>
    <title>Test Specific Simulation</title>
</head>
<body>
    <h1>Test Specific Simulation: 36a513fc-86e3-4491-b41e-ce188b297783</h1>
    <div id="output"></div>
    
    <script>
        const SIMULATION_ID = '36a513fc-86e3-4491-b41e-ce188b297783';
        const STORAGE_KEY = 'simulation_results';
        
        async function testSpecificSimulation() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üß™ Testing Specific Simulation</h2>';
            
            // Step 1: Check if it's already in localStorage
            output.innerHTML += '<h3>Step 1: Check localStorage</h3>';
            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const found = existingResults.find(sim => 
                sim.simulation_id === SIMULATION_ID || 
                sim.results?.simulation_id === SIMULATION_ID
            );
            
            if (found) {
                output.innerHTML += '<p style="color: green;">‚úÖ Simulation already in localStorage</p>';
                output.innerHTML += `<p>Source: ${found.source}</p>`;
                output.innerHTML += `<p>Timestamp: ${found.timestamp}</p>`;
            } else {
                output.innerHTML += '<p style="color: red;">‚ùå Simulation NOT in localStorage</p>';
            }
            
            // Step 2: Test progress endpoint (should return 404)
            output.innerHTML += '<h3>Step 2: Test Progress Endpoint</h3>';
            try {
                const progressResponse = await fetch(`http://localhost:8000/api/research/simulation-bridge/simulate/${SIMULATION_ID}/progress`);
                output.innerHTML += `<p>Progress endpoint status: <strong>${progressResponse.status}</strong></p>`;
                
                if (progressResponse.status === 404) {
                    output.innerHTML += '<p style="color: green;">‚úÖ Got expected 404 from progress endpoint</p>';
                } else {
                    output.innerHTML += '<p style="color: orange;">‚ö†Ô∏è Progress endpoint did not return 404</p>';
                    if (progressResponse.ok) {
                        const progressData = await progressResponse.json();
                        output.innerHTML += `<pre>${JSON.stringify(progressData, null, 2)}</pre>`;
                    }
                }
            } catch (progressError) {
                output.innerHTML += `<p style="color: red;">‚ùå Error testing progress endpoint: ${progressError.message}</p>`;
            }
            
            // Step 3: Test completed endpoint
            output.innerHTML += '<h3>Step 3: Test Completed Endpoint</h3>';
            try {
                const completedResponse = await fetch(`http://localhost:8000/api/research/simulation-bridge/completed/${SIMULATION_ID}`);
                output.innerHTML += `<p>Completed endpoint status: <strong>${completedResponse.status}</strong></p>`;
                
                if (completedResponse.ok) {
                    const result = await completedResponse.json();
                    output.innerHTML += '<p style="color: green;">‚úÖ Successfully fetched completed simulation</p>';
                    output.innerHTML += `<p>Simulation ID: <strong>${result.simulation_id}</strong></p>`;
                    output.innerHTML += `<p>Success: <strong>${result.success}</strong></p>`;
                    output.innerHTML += `<p>Message: <strong>${result.message}</strong></p>`;
                    output.innerHTML += `<p>Has Data: <strong>${!!result.data}</strong></p>`;
                    output.innerHTML += `<p>Has Interviews: <strong>${!!(result.interviews || result.data?.interviews)}</strong></p>`;
                    output.innerHTML += `<p>Interview Count: <strong>${(result.interviews || result.data?.interviews || []).length}</strong></p>`;
                    
                    // Step 4: Test localStorage saving (simulate 404 handler)
                    output.innerHTML += '<h3>Step 4: Simulate 404 Handler localStorage Saving</h3>';
                    
                    if (!found) {
                        const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                        const newSimulationEntry = {
                            simulation_id: result.simulation_id || SIMULATION_ID,
                            timestamp: new Date().toISOString(),
                            results: result,
                            source: 'manual_404_test'
                        };
                        existingResults.push(newSimulationEntry);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
                        
                        output.innerHTML += '<p style="color: green;">‚úÖ Manually saved to localStorage</p>';
                        output.innerHTML += `<p>Total simulations in storage: <strong>${existingResults.length}</strong></p>`;
                        
                        // Verify it was saved
                        const verification = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                        const nowFound = verification.find(sim => 
                            sim.simulation_id === SIMULATION_ID || 
                            sim.results?.simulation_id === SIMULATION_ID
                        );
                        
                        if (nowFound) {
                            output.innerHTML += '<p style="color: green;">‚úÖ Verified: Simulation now in localStorage</p>';
                        } else {
                            output.innerHTML += '<p style="color: red;">‚ùå Failed: Simulation still not in localStorage</p>';
                        }
                    } else {
                        output.innerHTML += '<p style="color: blue;">‚ÑπÔ∏è Simulation already in localStorage, skipping save</p>';
                    }
                    
                } else {
                    const errorData = await completedResponse.json().catch(() => ({}));
                    output.innerHTML += `<p style="color: red;">‚ùå Failed to fetch completed simulation: ${completedResponse.status}</p>`;
                    output.innerHTML += `<p>Error: ${JSON.stringify(errorData, null, 2)}</p>`;
                }
            } catch (completedError) {
                output.innerHTML += `<p style="color: red;">‚ùå Error testing completed endpoint: ${completedError.message}</p>`;
            }
            
            // Step 5: Check browser console for errors
            output.innerHTML += '<h3>Step 5: Instructions</h3>';
            output.innerHTML += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>üîç Next Steps:</h4>
                    <ol>
                        <li>Check the browser console (F12) for any JavaScript errors</li>
                        <li>If the simulation was saved to localStorage, refresh the simulation history page</li>
                        <li>If it's still not showing, there might be an issue with the simulation history page loading logic</li>
                    </ol>
                    <p><strong>Expected Result:</strong> The simulation should now appear in the simulation history page.</p>
                </div>
            `;
            
            // Add action buttons
            output.innerHTML += `
                <h3>üîß Actions:</h3>
                <button onclick="window.open('/unified-dashboard/simulation-history', '_blank')">Open Simulation History</button>
                <button onclick="clearStorage()">Clear Storage</button>
                <button onclick="testSpecificSimulation()">Re-run Test</button>
                <button onclick="showAllStorage()">Show All Storage</button>
            `;
        }
        
        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            alert('Storage cleared');
            testSpecificSimulation();
        }
        
        function showAllStorage() {
            const storage = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const popup = window.open('', '_blank', 'width=800,height=600');
            popup.document.write(`
                <html>
                    <head><title>All Simulation Storage</title></head>
                    <body>
                        <h1>All Simulation Storage (${storage.length} items)</h1>
                        <pre>${JSON.stringify(storage, null, 2)}</pre>
                    </body>
                </html>
            `);
        }
        
        // Run test on page load
        testSpecificSimulation();
    </script>
</body>
</html>
