<!DOCTYPE html>
<html>
<head>
    <title>Test API Service Session</title>
</head>
<body>
    <h1>Test API Service Session</h1>
    <div id="output"></div>

    <script>
        const SESSION_STORAGE_KEY = 'axwise_research_sessions';
        const TARGET_SESSION_ID = 'local_1753257997112_sea7vym8q';

        function testApiServiceSession() {
            try {
                const output = document.getElementById('output');

                if (!output) {
                    console.error('Output element not found');
                    return;
                }

                output.innerHTML = `
                    <h2>üîç TESTING API SERVICE SESSION</h2>
                    <p><strong>Target Session ID:</strong> ${TARGET_SESSION_ID}</p>
                `;

                console.log('Starting session test...');

                // Load sessions
                const sessions = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '{}');
                console.log('Loaded sessions:', Object.keys(sessions).length);

                // Find the target session
                const targetSession = Object.values(sessions).find(s => s.session_id === TARGET_SESSION_ID);
                console.log('Target session found:', !!targetSession);

            if (!targetSession) {
                output.innerHTML += `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚ùå Target Session Not Found</h4>
                        <p>Session ${TARGET_SESSION_ID} was not found.</p>
                        <p><strong>Available Sessions:</strong></p>
                        <ul>
                            ${Object.values(sessions).map(s => `<li>${s.session_id} - ${s.business_idea || 'No idea'}</li>`).join('')}
                        </ul>
                    </div>
                `;
                return;
            }

            output.innerHTML += `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>‚úÖ Target Session Found</h4>
                    <p><strong>Business Idea:</strong> ${targetSession.business_idea}</p>
                    <p><strong>Target Customer:</strong> ${targetSession.target_customer}</p>
                    <p><strong>Problem:</strong> ${targetSession.problem}</p>
                    <p><strong>Questions Generated:</strong> ${targetSession.questions_generated ? 'Yes' : 'No'}</p>
                    <p><strong>Messages:</strong> ${targetSession.messages?.length || 0}</p>
                </div>
            `;

            // Check questionnaire data
            const questionnaireMessage = targetSession.messages?.find(msg =>
                msg.metadata?.comprehensiveQuestions
            );

            if (!questionnaireMessage) {
                output.innerHTML += `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚ùå No Questionnaire Data</h4>
                        <p>This session doesn't have questionnaire data.</p>
                    </div>
                `;
                return;
            }

            const questionnaire = questionnaireMessage.metadata.comprehensiveQuestions;
            const primaryCount = questionnaire.primaryStakeholders?.length || 0;
            const secondaryCount = questionnaire.secondaryStakeholders?.length || 0;
            const totalQuestions = questionnaire.timeEstimate?.totalQuestions || 0;

            output.innerHTML += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>üìã Questionnaire Data Found</h4>
                    <p><strong>Primary Stakeholders:</strong> ${primaryCount}</p>
                    <p><strong>Secondary Stakeholders:</strong> ${secondaryCount}</p>
                    <p><strong>Total Questions:</strong> ${totalQuestions}</p>

                    <h5>Stakeholders:</h5>
                    <ul>
                        ${(questionnaire.primaryStakeholders || []).map(s =>
                            `<li><strong>Primary:</strong> ${s.name || s.title} (${(s.questions?.problemDiscovery?.length || 0) + (s.questions?.solutionValidation?.length || 0) + (s.questions?.followUp?.length || 0)} questions)</li>`
                        ).join('')}
                        ${(questionnaire.secondaryStakeholders || []).map(s =>
                            `<li><strong>Secondary:</strong> ${s.name || s.title} (${(s.questions?.problemDiscovery?.length || 0) + (s.questions?.solutionValidation?.length || 0) + (s.questions?.followUp?.length || 0)} questions)</li>`
                        ).join('')}
                    </ul>
                </div>
            `;

            // Add test simulation button
            output.innerHTML += `
                <h3>üß™ Test Actions:</h3>
                <button onclick="testSimulationDirectly()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    üöÄ Run API Service Simulation Now
                </button>
                <button onclick="window.open('/unified-dashboard/research', '_blank')" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    üìä Open Research Page
                </button>
                <button onclick="testApiServiceSession()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    üîÑ Refresh Test
                </button>

                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h4>üìã Instructions:</h4>
                    <ol>
                        <li><strong>Click "Run API Service Simulation Now"</strong> to directly test this session</li>
                        <li><strong>Check the browser console</strong> for detailed logs</li>
                        <li><strong>If successful</strong>, check the simulation history page</li>
                        <li><strong>If it fails</strong>, we'll see the exact error message</li>
                    </ol>
                </div>
            `;
        }

        async function testSimulationDirectly() {
            try {
                console.log('üöÄ Starting direct API service simulation test...');

                // Get the session data
                const sessions = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '{}');
                const session = Object.values(sessions).find(s => s.session_id === TARGET_SESSION_ID);

                if (!session) {
                    alert('‚ùå Session not found');
                    return;
                }

                console.log('‚úÖ Found session:', session);

                // Get questionnaire data
                const questionnaireMessage = session.messages?.find(msg =>
                    msg.metadata?.comprehensiveQuestions
                );

                if (!questionnaireMessage) {
                    alert('‚ùå No questionnaire data found');
                    return;
                }

                const rawQuestionnaireData = questionnaireMessage.metadata.comprehensiveQuestions;
                console.log('üìã Raw questionnaire data:', rawQuestionnaireData);

                // Transform data (same as research page)
                const transformStakeholder = (stakeholder, index) => ({
                    id: stakeholder.id || \`stakeholder_\${index}\`,
                    name: stakeholder.name || stakeholder.title || \`Stakeholder \${index + 1}\`,
                    description: stakeholder.description || stakeholder.role || '',
                    questions: [
                        ...(stakeholder.questions?.problemDiscovery || []),
                        ...(stakeholder.questions?.solutionValidation || []),
                        ...(stakeholder.questions?.followUp || [])
                    ]
                });

                const questionnaireData = {
                    stakeholders: {
                        primary: (rawQuestionnaireData.primaryStakeholders || []).map(transformStakeholder),
                        secondary: (rawQuestionnaireData.secondaryStakeholders || []).map(transformStakeholder)
                    },
                    timeEstimate: rawQuestionnaireData.timeEstimate || { totalQuestions: 0 }
                };

                const businessContext = {
                    business_idea: session.business_idea || '',
                    target_customer: session.target_customer || '',
                    problem: session.problem || '',
                    industry: session.industry || 'general'
                };

                const config = {
                    depth: "detailed",
                    people_per_stakeholder: 5,
                    response_style: "realistic",
                    include_insights: false,
                    temperature: 0.7
                };

                console.log('üîÑ Sending simulation request:', {
                    questions_data: questionnaireData,
                    business_context: businessContext,
                    config: config
                });

                // Call the simulation API
                const response = await fetch('http://localhost:8000/api/research/simulation-bridge/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questions_data: questionnaireData,
                        business_context: businessContext,
                        config: config
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Simulation successful:', result);

                    // Save to localStorage
                    const existingResults = JSON.parse(localStorage.getItem('simulation_results') || '[]');
                    const newSimulationEntry = {
                        simulation_id: result.simulation_id,
                        timestamp: new Date().toISOString(),
                        results: result,
                        source: 'direct_api_test'
                    };
                    existingResults.push(newSimulationEntry);
                    localStorage.setItem('simulation_results', JSON.stringify(existingResults));

                    // Dispatch event for real-time updates
                    window.dispatchEvent(new CustomEvent('localStorageUpdated', {
                        detail: { key: 'simulation_results', action: 'add', simulationId: result.simulation_id }
                    }));

                    alert(\`‚úÖ API Service Simulation Successful!\nSimulation ID: \${result.simulation_id}\nInterviews: \${(result.interviews || result.data?.interviews || []).length}\n\nCheck the simulation history page!\`);

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Simulation failed:', errorData);
                    alert(\`‚ùå Simulation failed (\${response.status}):\n\${errorData.detail || response.statusText}\`);
                }

            } catch (error) {
                console.error('‚ùå Test error:', error);
                alert(\`‚ùå Test failed: \${error.message}\`);
            }
        }

            } catch (error) {
                console.error('Error in testApiServiceSession:', error);
                const output = document.getElementById('output');
                if (output) {
                    output.innerHTML = `
                        <h2>‚ùå Error Loading Page</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Check the browser console for more details.</p>
                    `;
                }
            }
        }

        // Run test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting test...');
            testApiServiceSession();
        });
    </script>
</body>
</html>
