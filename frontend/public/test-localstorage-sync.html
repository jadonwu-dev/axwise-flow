<!DOCTYPE html>
<html>
<head>
    <title>Test localStorage Sync</title>
</head>
<body>
    <h1>Test localStorage Synchronization</h1>
    <div id="output"></div>
    
    <script>
        const STORAGE_KEY = 'simulation_results';
        const TARGET_SIMULATION_ID = '36a513fc-86e3-4491-b41e-ce188b297783';
        
        function testLocalStorageSync() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîÑ Testing localStorage Synchronization</h2>
                <p>This test verifies that the React simulation history page updates when localStorage changes.</p>
            `;
            
            // Check current state
            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const targetExists = existingResults.find(sim => 
                sim.simulation_id === TARGET_SIMULATION_ID || 
                sim.results?.simulation_id === TARGET_SIMULATION_ID
            );
            
            output.innerHTML += `
                <h3>üìä Current State:</h3>
                <p><strong>Total Simulations:</strong> ${existingResults.length}</p>
                <p><strong>Target Simulation (${TARGET_SIMULATION_ID}):</strong> ${targetExists ? 'EXISTS' : 'NOT FOUND'}</p>
            `;
            
            if (!targetExists) {
                output.innerHTML += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚ö†Ô∏è Target Simulation Not Found</h4>
                        <p>The simulation ${TARGET_SIMULATION_ID} is not in localStorage.</p>
                        <p>This means either:</p>
                        <ul>
                            <li>The 404 handler didn't save it correctly</li>
                            <li>The simulation ID is different</li>
                            <li>The data was cleared</li>
                        </ul>
                        <button onclick="fetchAndSaveTargetSimulation()">Fetch and Save Target Simulation</button>
                    </div>
                `;
            } else {
                output.innerHTML += `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚úÖ Target Simulation Found</h4>
                        <p>Source: ${targetExists.source}</p>
                        <p>Timestamp: ${new Date(targetExists.timestamp).toLocaleString()}</p>
                        <p>Has Results: ${!!targetExists.results}</p>
                        <p>Has Interviews: ${!!(targetExists.results?.interviews || targetExists.results?.data?.interviews)}</p>
                    </div>
                `;
            }
            
            // Add test actions
            output.innerHTML += `
                <h3>üß™ Test Actions:</h3>
                <button onclick="addTestSimulation()">Add Test Simulation</button>
                <button onclick="triggerCustomEvent()">Trigger Custom Event</button>
                <button onclick="openHistoryPage()">Open History Page</button>
                <button onclick="clearStorage()">Clear Storage</button>
                <button onclick="testLocalStorageSync()">Refresh Test</button>
            `;
            
            // Add instructions
            output.innerHTML += `
                <h3>üìã Test Instructions:</h3>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <ol>
                        <li><strong>Open the simulation history page</strong> in another tab</li>
                        <li><strong>Click "Add Test Simulation"</strong> below</li>
                        <li><strong>Check if the history page updates automatically</strong> (should show new simulation)</li>
                        <li><strong>If not automatic, click "Refresh" button</strong> on the history page</li>
                    </ol>
                    <p><strong>Expected Result:</strong> The history page should show the new simulation either automatically or after manual refresh.</p>
                </div>
            `;
        }
        
        async function fetchAndSaveTargetSimulation() {
            try {
                const response = await fetch(`http://localhost:8000/api/research/simulation-bridge/completed/${TARGET_SIMULATION_ID}`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Save to localStorage (simulate 404 handler)
                    const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const newSimulationEntry = {
                        simulation_id: result.simulation_id || TARGET_SIMULATION_ID,
                        timestamp: new Date().toISOString(),
                        results: result,
                        source: 'manual_fetch_test'
                    };
                    existingResults.push(newSimulationEntry);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
                    
                    // Dispatch custom event
                    window.dispatchEvent(new CustomEvent('localStorageUpdated', { 
                        detail: { key: 'simulation_results', action: 'add', simulationId: result.simulation_id || TARGET_SIMULATION_ID }
                    }));
                    
                    alert(`‚úÖ Successfully fetched and saved target simulation!\nID: ${result.simulation_id || TARGET_SIMULATION_ID}`);
                    testLocalStorageSync(); // Refresh
                } else {
                    alert(`‚ùå Failed to fetch simulation: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function addTestSimulation() {
            const testSimulationId = `test-sync-${Date.now()}`;
            
            // Create mock simulation data
            const mockSimulation = {
                simulation_id: testSimulationId,
                timestamp: new Date().toISOString(),
                results: {
                    simulation_id: testSimulationId,
                    success: true,
                    message: 'Test simulation for sync testing',
                    data: {
                        interviews: Array(5).fill(null).map((_, i) => ({
                            id: i,
                            stakeholder: `Test Stakeholder ${i + 1}`,
                            content: `Mock interview content ${i + 1}`
                        }))
                    }
                },
                source: 'sync_test'
            };
            
            // Save to localStorage
            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            existingResults.push(mockSimulation);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
            
            // Dispatch custom event
            window.dispatchEvent(new CustomEvent('localStorageUpdated', { 
                detail: { key: 'simulation_results', action: 'add', simulationId: testSimulationId }
            }));
            
            alert(`‚úÖ Added test simulation: ${testSimulationId}\nCheck if the history page updates automatically!`);
            testLocalStorageSync(); // Refresh
        }
        
        function triggerCustomEvent() {
            window.dispatchEvent(new CustomEvent('localStorageUpdated', { 
                detail: { key: 'simulation_results', action: 'refresh' }
            }));
            alert('üîÑ Triggered custom localStorage update event');
        }
        
        function openHistoryPage() {
            window.open('/unified-dashboard/simulation-history', '_blank');
        }
        
        function clearStorage() {
            if (confirm('Clear all simulation storage?')) {
                localStorage.removeItem(STORAGE_KEY);
                
                // Dispatch custom event
                window.dispatchEvent(new CustomEvent('localStorageUpdated', { 
                    detail: { key: 'simulation_results', action: 'clear' }
                }));
                
                alert('‚úÖ Storage cleared');
                testLocalStorageSync(); // Refresh
            }
        }
        
        // Run test on page load
        testLocalStorageSync();
    </script>
</body>
</html>
