<!DOCTYPE html>
<html>
<head>
    <title>Debug Simulation Storage</title>
</head>
<body>
    <h1>Simulation Storage Debug</h1>
    <div id="output"></div>
    
    <script>
        const STORAGE_KEY = 'simulation_results';
        const TARGET_SIMULATION_ID = '5b03b0d0-7d01-4ab8-a530-1d2b255aa961';
        
        function debugSimulationStorage() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîç SIMULATION STORAGE DEBUG</h2>
                <p><strong>Target Simulation ID:</strong> ${TARGET_SIMULATION_ID}</p>
                <p><strong>Storage Key:</strong> ${STORAGE_KEY}</p>
            `;
            
            // Check localStorage
            const simulationResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            output.innerHTML += `
                <h3>üìä Storage Contents:</h3>
                <p><strong>Total Simulations:</strong> ${simulationResults.length}</p>
            `;
            
            // Check if target simulation exists
            const targetSimulation = simulationResults.find(sim => 
                sim.simulation_id === TARGET_SIMULATION_ID || 
                sim.results?.simulation_id === TARGET_SIMULATION_ID
            );
            
            output.innerHTML += `
                <h3>üéØ Target Simulation Status:</h3>
                <p><strong>Found in localStorage:</strong> ${targetSimulation ? 'YES' : 'NO'}</p>
            `;
            
            if (targetSimulation) {
                output.innerHTML += `
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h4>‚úÖ Target Simulation Details:</h4>
                        <p><strong>ID:</strong> ${targetSimulation.simulation_id}</p>
                        <p><strong>Timestamp:</strong> ${targetSimulation.timestamp}</p>
                        <p><strong>Source:</strong> ${targetSimulation.source}</p>
                        <p><strong>Has Results:</strong> ${!!targetSimulation.results}</p>
                        <p><strong>Has Interviews:</strong> ${!!(targetSimulation.results?.interviews || targetSimulation.results?.data?.interviews)}</p>
                    </div>
                `;
            }
            
            // List all simulations
            output.innerHTML += `<h3>üìã All Simulations (${simulationResults.length}):</h3>`;
            simulationResults.forEach((sim, i) => {
                const simId = sim.simulation_id || sim.results?.simulation_id || 'Unknown';
                const isTarget = simId === TARGET_SIMULATION_ID;
                const bgColor = isTarget ? '#ffe8e8' : '#f5f5f5';
                
                output.innerHTML += `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; background: ${bgColor};">
                        <h4>${i + 1}. ${simId} ${isTarget ? 'üéØ TARGET' : ''}</h4>
                        <p><strong>Timestamp:</strong> ${sim.timestamp || 'Unknown'}</p>
                        <p><strong>Source:</strong> ${sim.source || 'Unknown'}</p>
                        <p><strong>Has Results:</strong> ${!!sim.results}</p>
                        ${sim.results ? `
                            <p><strong>Business Context:</strong> ${sim.results.business_context || 'None'}</p>
                            <p><strong>Interviews:</strong> ${(sim.results.interviews || sim.results.data?.interviews || []).length}</p>
                        ` : ''}
                    </div>
                `;
            });
            
            // Test actions
            output.innerHTML += `
                <h3>üß™ Test Actions:</h3>
                <button onclick="testFetchCompletedSimulation()">Test Fetch Completed Simulation</button>
                <button onclick="clearSimulationStorage()">Clear Storage</button>
                <button onclick="window.location.reload()">Refresh Page</button>
            `;
        }
        
        async function testFetchCompletedSimulation() {
            try {
                const response = await fetch(`http://localhost:8000/api/research/simulation-bridge/completed/${TARGET_SIMULATION_ID}`);
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Successfully fetched simulation from backend!\nID: ${result.simulation_id}\nInterviews: ${(result.interviews || result.data?.interviews || []).length}`);
                    
                    // Save to localStorage to test the fix
                    const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const newSimulationEntry = {
                        simulation_id: result.simulation_id,
                        timestamp: new Date().toISOString(),
                        results: result,
                        source: 'manual_test'
                    };
                    existingResults.push(newSimulationEntry);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
                    
                    debugSimulationStorage(); // Refresh display
                } else {
                    alert(`‚ùå Failed to fetch simulation: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function clearSimulationStorage() {
            if (confirm('Clear all simulation storage?')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('‚úÖ Storage cleared');
                debugSimulationStorage(); // Refresh
            }
        }
        
        // Run debug on page load
        debugSimulationStorage();
    </script>
</body>
</html>
