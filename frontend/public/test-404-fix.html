<!DOCTYPE html>
<html>
<head>
    <title>Test 404 Fix</title>
</head>
<body>
    <h1>Test 404 Handling Fix</h1>
    <div id="output"></div>
    
    <script>
        const SIMULATION_ID = '5b03b0d0-7d01-4ab8-a530-1d2b255aa961';
        const STORAGE_KEY = 'simulation_results';
        
        async function test404Fix() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üß™ Testing 404 Fix Logic</h2>';
            
            // Step 1: Test progress endpoint (should return 404)
            output.innerHTML += '<h3>Step 1: Testing Progress Endpoint</h3>';
            try {
                const progressResponse = await fetch(`http://localhost:8000/api/research/simulation-bridge/simulate/${SIMULATION_ID}/progress`);
                output.innerHTML += `<p>Progress endpoint status: <strong>${progressResponse.status}</strong></p>`;
                
                if (progressResponse.status === 404) {
                    output.innerHTML += '<p style="color: green;">‚úÖ Got expected 404 from progress endpoint</p>';
                    
                    // Step 2: Test completed endpoint (should work)
                    output.innerHTML += '<h3>Step 2: Testing Completed Endpoint</h3>';
                    try {
                        const completedResponse = await fetch(`http://localhost:8000/api/research/simulation-bridge/completed/${SIMULATION_ID}`);
                        output.innerHTML += `<p>Completed endpoint status: <strong>${completedResponse.status}</strong></p>`;
                        
                        if (completedResponse.ok) {
                            const result = await completedResponse.json();
                            output.innerHTML += '<p style="color: green;">‚úÖ Successfully fetched completed simulation</p>';
                            output.innerHTML += `<p>Simulation ID: <strong>${result.simulation_id}</strong></p>`;
                            output.innerHTML += `<p>Interviews: <strong>${(result.interviews || result.data?.interviews || []).length}</strong></p>`;
                            
                            // Step 3: Test localStorage saving
                            output.innerHTML += '<h3>Step 3: Testing localStorage Saving</h3>';
                            const existingResults = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                            const newSimulationEntry = {
                                simulation_id: result.simulation_id || SIMULATION_ID,
                                timestamp: new Date().toISOString(),
                                results: result,
                                source: '404_test_fix'
                            };
                            existingResults.push(newSimulationEntry);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(existingResults));
                            
                            output.innerHTML += '<p style="color: green;">‚úÖ Successfully saved to localStorage</p>';
                            output.innerHTML += `<p>Total simulations in storage: <strong>${existingResults.length}</strong></p>`;
                            
                            // Step 4: Verify it's in localStorage
                            const verification = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                            const found = verification.find(sim => 
                                sim.simulation_id === SIMULATION_ID || 
                                sim.results?.simulation_id === SIMULATION_ID
                            );
                            
                            if (found) {
                                output.innerHTML += '<p style="color: green;">‚úÖ Verified simulation is now in localStorage</p>';
                                output.innerHTML += '<p style="color: blue;">üéØ The 404 fix should work! Try refreshing the simulation history page.</p>';
                            } else {
                                output.innerHTML += '<p style="color: red;">‚ùå Simulation not found in localStorage after saving</p>';
                            }
                            
                        } else {
                            output.innerHTML += '<p style="color: red;">‚ùå Failed to fetch completed simulation</p>';
                        }
                    } catch (completedError) {
                        output.innerHTML += `<p style="color: red;">‚ùå Error fetching completed simulation: ${completedError.message}</p>`;
                    }
                    
                } else {
                    output.innerHTML += '<p style="color: orange;">‚ö†Ô∏è Progress endpoint did not return 404 as expected</p>';
                }
                
            } catch (progressError) {
                output.innerHTML += `<p style="color: red;">‚ùå Error testing progress endpoint: ${progressError.message}</p>`;
            }
            
            // Add buttons for manual actions
            output.innerHTML += `
                <h3>üîß Manual Actions</h3>
                <button onclick="window.open('/unified-dashboard/simulation-history', '_blank')">Open Simulation History</button>
                <button onclick="clearStorage()">Clear Storage</button>
                <button onclick="test404Fix()">Re-run Test</button>
            `;
        }
        
        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            alert('Storage cleared');
        }
        
        // Run test on page load
        test404Fix();
    </script>
</body>
</html>
