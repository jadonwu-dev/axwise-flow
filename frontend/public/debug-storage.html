<!DOCTYPE html>
<html>
<head>
    <title>Debug Storage on App Domain</title>
</head>
<body>
    <h1>Storage Debug on Application Domain</h1>
    <div id="output"></div>
    
    <script>
        const STORAGE_KEY = 'axwise_research_sessions';
        
        function debugAppStorage() {
            const output = document.getElementById('output');
            
            output.innerHTML = `
                <h2>üîç APPLICATION DOMAIN STORAGE DEBUG</h2>
                <p><strong>Domain:</strong> ${window.location.hostname}:${window.location.port}</p>
                <p><strong>Full URL:</strong> ${window.location.href}</p>
                <p><strong>Storage Key:</strong> ${STORAGE_KEY}</p>
            `;
            
            // Check localStorage
            const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const currentSession = localStorage.getItem('axwise_current_session');
            const userId = localStorage.getItem('axwise_anonymous_user_id');
            
            output.innerHTML += `
                <h3>üìä Storage Contents:</h3>
                <p><strong>Sessions:</strong> ${sessions.length}</p>
                <p><strong>Current Session:</strong> ${currentSession ? 'EXISTS' : 'NONE'}</p>
                <p><strong>User ID:</strong> ${userId || 'NONE'}</p>
            `;
            
            // List all localStorage keys
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }
            
            output.innerHTML += `
                <h3>üîë All localStorage Keys (${allKeys.length}):</h3>
                <ul>${allKeys.map(key => `<li>${key}</li>`).join('')}</ul>
            `;
            
            // Show sessions if any
            if (sessions.length > 0) {
                output.innerHTML += `<h3>üìã Session Details:</h3>`;
                sessions.forEach((session, i) => {
                    const hasQuestionnaire = session.messages?.some(m => m.metadata?.comprehensiveQuestions);
                    output.innerHTML += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                            <h4>${i + 1}. ${session.session_id}</h4>
                            <p><strong>Business Idea:</strong> ${session.business_idea || 'None'}</p>
                            <p><strong>Questions Generated:</strong> ${session.questions_generated}</p>
                            <p><strong>Messages:</strong> ${session.messages?.length || 0}</p>
                            <p><strong>Has Questionnaire:</strong> ${hasQuestionnaire ? 'YES' : 'NO'}</p>
                            <p><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</p>
                            ${hasQuestionnaire ? `
                                <p><a href="/unified-dashboard/questionnaire/${session.session_id}" target="_blank">
                                    View Questionnaire
                                </a></p>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            // Test session creation
            output.innerHTML += `
                <h3>üß™ Test Actions:</h3>
                <button onclick="createTestSessionOnApp()">Create Test Session</button>
                <button onclick="simulateQuestionnaireGeneration()">Simulate Questionnaire Generation</button>
                <button onclick="clearAppStorage()">Clear Storage</button>
                <button onclick="window.location.reload()">Refresh Page</button>
            `;
        }
        
        function createTestSessionOnApp() {
            const sessionId = \`local_\${Date.now()}_\${Math.random().toString(36).substr(2, 9)}\`;
            
            const testSession = {
                id: Date.now(),
                session_id: sessionId,
                user_id: 'test-user',
                business_idea: 'Test API service from app domain',
                target_customer: 'Account Managers',
                problem: 'Data arrives too late',
                industry: 'general',
                stage: 'initial',
                status: 'active',
                questions_generated: false,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                message_count: 0,
                messages: [],
                isLocal: true
            };
            
            try {
                const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                sessions.push(testSession);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
                
                alert(\`‚úÖ Test session created on app domain: \${sessionId}\`);
                debugAppStorage(); // Refresh
            } catch (error) {
                alert(\`‚ùå Failed: \${error.message}\`);
            }
        }
        
        function simulateQuestionnaireGeneration() {
            const sessionId = \`local_\${Date.now()}_\${Math.random().toString(36).substr(2, 9)}\`;
            
            const questionnaireMessage = {
                id: \`msg_\${Date.now()}\`,
                role: 'assistant',
                content: 'COMPREHENSIVE_QUESTIONS_COMPONENT',
                timestamp: new Date().toISOString(),
                metadata: {
                    comprehensiveQuestions: {
                        primaryStakeholders: [{
                            name: 'Account Managers',
                            description: 'Primary users of the API service',
                            questions: {
                                problemDiscovery: [
                                    'How often do you encounter delays in data processing?',
                                    'What impact do these delays have on your work?'
                                ],
                                solutionValidation: [
                                    'Would a unified API help solve this problem?',
                                    'What features would be most valuable?'
                                ],
                                followUp: [
                                    'How would you measure success?'
                                ]
                            }
                        }],
                        secondaryStakeholders: [{
                            name: 'IT Administrators',
                            description: 'Technical stakeholders',
                            questions: {
                                problemDiscovery: ['What are the technical challenges?'],
                                solutionValidation: ['How would this integrate with existing systems?'],
                                followUp: ['What are the security requirements?']
                            }
                        }],
                        timeEstimate: {
                            totalQuestions: 8,
                            estimatedMinutes: 40,
                            estimatedMinutesDisplay: '35-45',
                            breakdown: {
                                primary: 5,
                                secondary: 3,
                                perQuestion: 5
                            }
                        }
                    }
                }
            };
            
            const sessionWithQuestionnaire = {
                id: Date.now(),
                session_id: sessionId,
                user_id: 'test-user',
                business_idea: 'API service to pull and unify data from legacy source systems',
                target_customer: 'Account Managers',
                problem: 'Data from fragmented client companies arrives too late, making it difficult for Account Managers to timely calculate if volume discounts have been fulfilled.',
                industry: 'general',
                stage: 'completed',
                status: 'active',
                questions_generated: true,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                message_count: 1,
                messages: [questionnaireMessage],
                isLocal: true
            };
            
            try {
                const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                sessions.push(sessionWithQuestionnaire);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
                
                alert(\`‚úÖ Session with questionnaire created: \${sessionId}\`);
                
                // Open questionnaire page
                window.open(\`/unified-dashboard/questionnaire/\${sessionId}\`, '_blank');
                
                debugAppStorage(); // Refresh
            } catch (error) {
                alert(\`‚ùå Failed: \${error.message}\`);
            }
        }
        
        function clearAppStorage() {
            if (confirm('Clear all storage on app domain?')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem('axwise_current_session');
                localStorage.removeItem('axwise_anonymous_user_id');
                alert('‚úÖ Storage cleared');
                debugAppStorage(); // Refresh
            }
        }
        
        // Run debug on page load
        debugAppStorage();
    </script>
</body>
</html>
